$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://raw.githubusercontent.com/taverntesting/tavern/master/tavern/schemas/tests.jsonschema.yaml"

title: Tavern
description: "Schema for Tavern test files"

###

definitions:
  strict_block:
    oneOf:
      - type: string
      - type: boolean
      - type: array
        items:
          type: string

  verify_block:
    type: object
    additionalProperties: false

    required:
      - function
    properties:
      function:
        type: string
        description: Path to function in the form import.path:name

      extra_args:
        type: array

      extra_kwargs:
        type: object

  any_json:
    oneOf:
      - type: array
      - type: object
      - type: number
      - type: string
      - type: boolean

  included_file:
    type: object
    additionalProperties: false

    properties:
      name:
        type: string
        description: Name for this included file

      description:
        type: string
        description: Extra description for included file

      variables:
        type: object
        description: Variables to use in tests

      stages:
        type: array
        description: Stages to reference from tests

        items:
          $ref: "#/definitions/stage"

  stage_ref:
    type: object
    description: Reference to another stage from an included config file
    additionalProperties: false

    required:
      - type
      - id

    properties:
      type:
        type: string
        pattern: ^ref$

      id:
        type: string

  stage:
    type: object
    description: One stage in a test
    additionalProperties: false
    required:
      - name

    properties:
      tinctures:
        type: array
        description: Tinctures for stage
        items:
          $ref: "#/definitions/verify_block"

      id:
        type: string
        description: ID of stage for use in stage references

      max_retries:
        type: integer
        description: Number of times to retry this request
        default: 0

      skip:
        oneOf:
          - type: boolean
            description: Whether to skip this stage
            default: false

          - type: string
            description: CEL expression saying whether to skip this stage

      only:
        type: boolean
        description: Only run this stage
        default: false

      delay_before:
        type: number
        description: How long to delay before running stage

      delay_after:
        type: number
        description: How long to delay after running stage

      name:
        type: string
        description: Name of this stage

###

type: object
additionalProperties: false

properties:
  test_name:
    type: string
    description: Name of test

  is_defaults:
    type: boolean
    description: Whether this document contains default values to be merged with subsequent test documents
    default: false

  _xfail:
    oneOf:
      - type: string
        enum:
          - verify
          - run
          - finally
      - type: object
        properties:
          verify:
            type: string
          run:
            type: string

  marks:
    type: array
    description: Pytest marks to use on test
    items:
      anyOf:
        - type: string
        - type: object
          additionalProperties: false
          properties:
            filterwarnings:
              type: string

            skipif:
              type: string

            usefixtures:
              type: array
              items:
                type: string

            parametrize:
              type: object
              required:
                - key
                - vals

  tinctures:
    type: array
    description: Tinctures for whole test
    items:
      $ref: "#/definitions/verify_block"

  strict:
    $ref: "#/definitions/strict_block"

  includes:
    type: array
    minItems: 1
    items:
      $ref: "#/definitions/included_file"

  stages:
    type: array
    description: Stages in test
    minItems: 1

    items:
      oneOf:
        - $ref: "#/definitions/stage"
        - $ref: "#/definitions/stage_ref"

  finally:
    type: array
    description: Stages to run after test finishes

    items:
      oneOf:
        - $ref: "#/definitions/stage"
        - $ref: "#/definitions/stage_ref"
