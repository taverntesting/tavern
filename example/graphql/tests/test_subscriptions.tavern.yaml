---
test_name: test user subscription update

includes:
  - !include graphql_config.yaml

stages:
  - name: Create initial user
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation CreateUser($name: String!, $email: String!) {
          createUser(name: $name, email: $email) {
            id
            name
            email
          }
        }
      variables:
        name: "Alice Smith"
        email: "alice@example.com"
    graphql_response:
      data:
        createUser:
          id: !anyint
          name: "Alice Smith"
          email: "alice@example.com"

      save:
        data:
          user_id: data.createUser.id

  - name: Subscribe to user updates
    graphql_request:
      operation_name: GetUser
      url: "{graphql_server_url}/graphql"
      query: |
        subscription GetUser($id: ID!) {
          user(id: $id) {
            id
            name
            email
          }
        }
      variables:
        id: "1"

  - name: Update user and expect subscription notification
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation UpdateUser($id: ID!, $name: String!, $email: String!) {
          updateUser(id: $id, name: $name, email: $email) {
            id
            name
            email
          }
        }
      variables:
        id: "1"
        name: "Alice Johnson"
        email: "alice.j@example.com"
    graphql_response:
      - subscription: GetUser
        data:
          user:
            id: !anyint
            name: "Alice Johnson"
            email: "alice.j@example.com"
      - data:
          updateUser:
            id: !anyint
            name: "Alice Johnson"
            email: "alice.j@example.com"

---

test_name: test user subscription update on authenticated endpoint

includes:
  - !include graphql_config.yaml

stages:
  - name: Create initial user
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation CreateUser($name: String!, $email: String!) {
          createUser(name: $name, email: $email) {
            id
            name
            email
          }
        }
      variables:
        name: "Alice Smith"
        email: "alice@example.com"
    graphql_response:
      data:
        createUser:
          id: !anyint
          name: "Alice Smith"
          email: "alice@example.com"

      save:
        data:
          user_id: data.createUser.id

  - name: Subscribe to user updates
    graphql_request:
      operation_name: GetUser
      url: "{graphql_server_url}/graphql_authenticated"
      query: |
        subscription GetUser($id: ID!) {
          user(id: $id) {
            id
            name
            email
          }
        }
      variables:
        id: "1"

  - name: Update user and expect subscription notification
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation UpdateUser($id: ID!, $name: String!, $email: String!) {
          updateUser(id: $id, name: $name, email: $email) {
            id
            name
            email
          }
        }
      variables:
        id: "1"
        name: "Alice Johnson"
        email: "alice.j@example.com"
    graphql_response:
      - subscription: GetUser
        data:
          user:
            id: !anyint
            name: "Alice Johnson"
            email: "alice.j@example.com"
      - data:
          updateUser:
            id: !anyint
            name: "Alice Johnson"
            email: "alice.j@example.com"

---
test_name: test subscription no update

includes:
  - !include graphql_config.yaml

stages:
  - name: Subscribe to non-existent user
    graphql_request:
      operation_name: GetUser
      url: "{graphql_server_url}/graphql"
      query: |
        subscription GetUser($id: ID!) {
          user(id: $id) {
            id
            name
          }
        }
      variables:
        id: "999"

  - name: Perform unrelated mutation
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation {
          createUser(name: "Bob", email: "bob@example.com") {
            id
          }
        }
    graphql_response:
      - data:
          user:
            id: !anyint
      - subscription: GetUser
        timeout: 1
        data:
          user:
            id: "1"

_xfail:
  run: Timed out waiting for subscription message on 'GetUser'

---
test_name: test multiple concurrent subscriptions

includes:
  - !include graphql_config.yaml

marks:
  - skip  # FIXME: Not sure why this is failin but the second subscription seems to be delayed so never received any updated

stages:
  - name: Create first user
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation CreateUser($name: String!, $email: String!) {
          createUser(name: $name, email: $email) {
            id
            name
            email
          }
        }
      variables:
        name: "First User"
        email: "first@example.com"
    graphql_response:
      data:
        createUser:
          id: !anyint
          name: "First User"
          email: "first@example.com"
      save:
        data:
          first_user_id: data.createUser.id

  - name: Create second user
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation CreateUser($name: String!, $email: String!) {
          createUser(name: $name, email: $email) {
            id
            name
            email
          }
        }
      variables:
        name: "Second User"
        email: "second@example.com"
    graphql_response:
      data:
        createUser:
          id: !anyint
          name: "Second User"
          email: "second@example.com"
      save:
        data:
          second_user_id: data.createUser.id

  - name: Subscribe to first user updates
    graphql_request:
      operation_name: FirstUserSubscription
      url: "{graphql_server_url}/graphql"
      query: |
        subscription FirstUserSubscription($id: ID!) {
          user(id: $id) {
            id
            name
            email
          }
        }
      variables:
        id: "{first_user_id}"

  - name: Subscribe to second user updates
    graphql_request:
      operation_name: SecondUserSubscription
      url: "{graphql_server_url}/graphql"
      query: |
        subscription SecondUserSubscription($id: ID!) {
          user(id: $id) {
            id
            name
            email
          }
        }
      variables:
        id: "{second_user_id}"

  - name: Update first user and verify subscription
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation UpdateUser($id: ID!, $name: String!, $email: String!) {
          updateUser(id: $id, name: $name, email: $email) {
            id
            name
            email
          }
        }
      variables:
        id: "{first_user_id}"
        name: "First User Updated"
        email: "first.updated@example.com"
    graphql_response:
      - subscription: FirstUserSubscription
        data:
          user:
            id: !int "{first_user_id}"
            name: "First User Updated"
            email: "first.updated@example.com"
      - data:
          updateUser:
            id: !int "{first_user_id}"
            name: "First User Updated"
            email: "first.updated@example.com"

  - name: Update second user and verify subscription
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation UpdateUser($id: ID!, $name: String!, $email: String!) {
          updateUser(id: $id, name: $name, email: $email) {
            id
            name
            email
          }
        }
      variables:
        id: "{second_user_id}"
        name: "Second User Updated"
        email: "second.updated@example.com"
    graphql_response:
      - subscription: SecondUserSubscription
        data:
          user:
            id: !int "{second_user_id}"
            name: "Second User Updated"
            email: "second.updated@example.com"
      - data:
          updateUser:
            id: !int "{second_user_id}"
            name: "Second User Updated"
            email: "second.updated@example.com"

---
test_name: test invalid subscription scenarios - invalid ID format

includes:
  - !include graphql_config.yaml

stages:
  - name: Attempt to subscribe with invalid ID type
    graphql_request:
      operation_name: InvalidSubscription
      url: "{graphql_server_url}/graphql"
      query: |
        subscription GetUser($id: ID!) {
          user(id: $id) {
            id
            name
            email
          }
        }
      variables:
        id: "invalid_id_format"


---
test_name: test invalid subscription scenarios - empty ID

includes:
  - !include graphql_config.yaml

stages:
  - name: Subscribe with empty ID
    graphql_request:
      operation_name: EmptyIdSubscription
      url: "{graphql_server_url}/graphql"
      query: |
        subscription GetUser($id: ID!) {
          user(id: $id) {
            id
            name
            email
          }
        }
      variables:
        id: ""

---
test_name: test invalid subscription scenarios - negative ID

includes:
  - !include graphql_config.yaml

stages:
  - name: Subscribe with negative ID
    graphql_request:
      operation_name: NegativeIdSubscription
      url: "{graphql_server_url}/graphql"
      query: |
        subscription GetUser($id: ID!) {
          user(id: $id) {
            id
            name
            email
          }
        }
      variables:
        id: "-1"

---
test_name: test error handling

includes:
  - !include graphql_config.yaml

stages:
  - name: Create user for error testing
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation CreateUser($name: String!, $email: String!) {
          createUser(name: $name, email: $email) {
            id
            name
            email
          }
        }
      variables:
        name: "Error Test User"
        email: "error@example.com"
    graphql_response:
      data:
        createUser:
          id: !anyint
          name: "Error Test User"
          email: "error@example.com"
      save:
        data:
          error_user_id: data.createUser.id

  - name: Subscribe to user updates
    graphql_request:
      operation_name: ErrorTestSubscription
      url: "{graphql_server_url}/graphql"
      query: |
        subscription ErrorTestSubscription($id: ID!) {
          user(id: $id) {
            id
            name
            email
          }
        }
      variables:
        id: "{error_user_id}"

  - name: Attempt to update non-existent user with error
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation UpdateNonExistentUser($id: ID!, $name: String!, $email: String!) {
          updateUser(id: $id, name: $name, email: $email) {
            id
            name
            email
          }
        }
      variables:
        id: "999999"
        name: "Non-existent user"
        email: "nonexistent@example.com"
    graphql_response:
      errors:
        - message: "User not found"

  - name: Update valid user and verify subscription still works
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation UpdateUser($id: ID!, $name: String!, $email: String!) {
          updateUser(id: $id, name: $name, email: $email) {
            id
            name
            email
          }
        }
      variables:
        id: "{error_user_id}"
        name: "Error Test User Updated"
        email: "error.updated@example.com"
    graphql_response:
      - subscription: ErrorTestSubscription
        data:
          user:
            id: !int "{error_user_id}"
            name: "Error Test User Updated"
            email: "error.updated@example.com"
      - data:
          updateUser:
            id: !int "{error_user_id}"
            name: "Error Test User Updated"
            email: "error.updated@example.com"

---
test_name: test complex subscription scenario with multiple operations

includes:
  - !include graphql_config.yaml

stages:
  - name: Create multiple users for complex test
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation CreateUser($name: String!, $email: String!) {
          createUser(name: $name, email: $email) {
            id
            name
            email
          }
        }
      variables:
        name: "Complex Test User"
        email: "complex@example.com"
    graphql_response:
      data:
        createUser:
          id: !anyint
          name: "Complex Test User"
          email: "complex@example.com"
      save:
        data:
          complex_user_id: data.createUser.id

  - name: Subscribe to user updates with complex subscription
    graphql_request:
      operation_name: ComplexSubscription
      url: "{graphql_server_url}/graphql"
      query: |
        subscription ComplexSubscription($id: ID!) {
          user(id: $id) {
            id
            name
            email
          }
        }
      variables:
        id: "{complex_user_id}"

  - name: Multiple operations in sequence - create user
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation CreateUser($name: String!, $email: String!) {
          createUser(name: $name, email: $email) {
            id
            name
            email
          }
        }
      variables:
        name: "Another User"
        email: "another@example.com"
    graphql_response:
      data:
        createUser:
          id: !anyint
          name: "Another User"
          email: "another@example.com"

  - name: Update user that we're subscribed to
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation UpdateUser($id: ID!, $name: String!, $email: String!) {
          updateUser(id: $id, name: $name, email: $email) {
            id
            name
            email
          }
        }
      variables:
        id: "{complex_user_id}"
        name: "Complex Test User Updated"
        email: "complex.updated@example.com"
    graphql_response:
      - subscription: ComplexSubscription
        data:
          user:
            id: !int "{complex_user_id}"
            name: "Complex Test User Updated"
            email: "complex.updated@example.com"
      - data:
          updateUser:
            id: !int "{complex_user_id}"
            name: "Complex Test User Updated"
            email: "complex.updated@example.com"

  - name: Final verification query
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        query GetUser($id: ID!) {
          user(id: $id) {
            id
            name
            email
          }
        }
      variables:
        id: "{complex_user_id}"
    graphql_response:
      data:
        user:
          id: !int "{complex_user_id}"
          name: "Complex Test User Updated"
          email: "complex.updated@example.com"
