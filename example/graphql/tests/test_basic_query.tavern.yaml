---
test_name: GraphQL basic query - Get user by ID

includes:
  - !include graphql_config.yaml

stages:
  - name: Create initial user
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation CreateUser($name: String!, $email: String!) {
          createUser(name: $name, email: $email) {
            id
            name
            email
          }
        }
      variables:
        name: "Alice Smith"
        email: "alice@example.com"
    graphql_response:
      data:
        createUser:
          id: !anyint
          name: "Alice Smith"
          email: "alice@example.com"

      save:
        data:
          user_id: data.createUser.id

  - name: Get user by ID
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        query GetUser($id: ID!) {
          user(id: $id) {
            id
            name
            email
          }
        }
      variables:
        id: "{user_id}"
    graphql_response:
      data:
        user:
          id: !int "{user_id}"
          name: !anystr
          email: !anystr

---
test_name: GraphQL basic query - Get all users

includes:
  - !include graphql_config.yaml

stages:
  - name: Create user 1
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation CreateUser($name: String!, $email: String!) {
          createUser(name: $name, email: $email) {
            id
            name
            email
          }
        }
      variables:
        name: "Alice Smith"
        email: "alice@example.com"
    graphql_response:
      data:
        createUser:
          id: !anyint
          name: "Alice Smith"
          email: "alice@example.com"

  - name: Create user 2
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation CreateUser($name: String!, $email: String!) {
          createUser(name: $name, email: $email) {
            id
            name
            email
          }
        }
      variables:
        name: "Jane Smith"
        email: "jane@example.com"
    graphql_response:
      data:
        createUser:
          id: !anyint
          name: "Jane Smith"
          email: "jane@example.com"

  - name: Get all users
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        query GetUsers {
          users {
            id
            name
            email
          }
        }
    graphql_response:
      data:
        users:
          - id: !anyint
            name: "Alice Smith"
            email: "alice@example.com"
          - id: !anyint
            name: "Jane Smith"
            email: "jane@example.com"

---

test_name: GraphQL basic query - Get posts for a user

includes:
  - !include graphql_config.yaml

stages:
  - name: Create user
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation CreateUser($name: String!, $email: String!) {
          createUser(name: $name, email: $email) {
            id
            name
            email
          }
        }
      variables:
        name: "Test User"
        email: "test@example.com"
    graphql_response:
      data:
        createUser:
          id: !anyint
          name: "Test User"
          email: "test@example.com"
      save:
        data:
          user_id: data.createUser.id

  - name: Create post 1 for user
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation CreatePost($title: String!, $content: String!, $authorId: String!) {
          createPost(title: $title, content: $content, authorId: $authorId) {
            id
            title
            content
            authorId
          }
        }
      variables:
        title: "First Test Post"
        content: "This is my first test post"
        authorId: "{user_id}"
    graphql_response:
      data:
        createPost:
          id: !anyint
          title: "First Test Post"
          content: "This is my first test post"
          authorId: !int "{user_id}"

  - name: Create post 2 for user
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        mutation CreatePost($title: String!, $content: String!, $authorId: String!) {
          createPost(title: $title, content: $content, authorId: $authorId) {
            id
            title
            content
            authorId
          }
        }
      variables:
        title: "Second Test Post"
        content: "This is my second test post"
        authorId: "{user_id}"
    graphql_response:
      data:
        createPost:
          id: !anyint
          title: "Second Test Post"
          content: "This is my second test post"
          authorId: !int "{user_id}"

  - name: Get posts for the user
    graphql_request:
      url: "{graphql_server_url}/graphql"
      query: |
        query GetPosts($authorId: ID!) {
          userPosts(authorId: $authorId) {
            id
            title
            content
            authorId
          }
        }
      variables:
        authorId: "{user_id}"
    graphql_response:
      data:
        userPosts:
          - id: !anyint
            title: "First Test Post"
            content: "This is my first test post"
            authorId: !int "{user_id}"
          - id: !anyint
            title: "Second Test Post"
            content: "This is my second test post"
            authorId: !int "{user_id}"
